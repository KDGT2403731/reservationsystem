<!-- HTML5 宣言 -->
<!DOCTYPE html>
<!-- ルート要素。日本語、Thymeleaf と Spring Security の名前空間を宣言 -->
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<!-- メタ情報・スタイル -->

<head>
	<!-- 文字コード -->
	<meta charset="UTF-8">
	<!-- ページタイトル -->
	<title>キャンセル待ち登録 - 予約管理システム</title>
	<!-- 共通スタイル -->
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<!-- jQuery 本体の読み込み（Ajax で空き枠確認に利用） -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<!-- 本文 -->

<body>
	<!-- レイアウトコンテナ -->
	<div class="container">
		<!-- 見出し -->
		<h1>キャンセル待ち登録</h1>
		<!-- ページ説明 -->
		<p>希望の日時が満席の場合、キャンセル待ちを登録できます。空きが出た場合、通知されます。</p>

		<!-- サーバサイドでの業務例外メッセージ表示領域 -->
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

		<!-- 成功メッセージ（登録完了時） -->
		<div th:if="${param.success}" class="success-message">
			<span th:if="${param.success[0] == 'registered'}">キャンセル待ちが登録されました。空きが出次第、通知いたします。</span>
			<span th:if="${param.success[0] == 'cancelled'}">キャンセル待ちを取り消しました。</span>
		</div>

		<!-- キャンセル待ち登録フォーム -->
		<form id="waitlistForm" th:action="@{/waitlist/register}" method="post" onsubmit="return validateForm()">
			<!-- CSRF トークン（実運用では必須） -->
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

			<!-- 入力ブロック：スタッフ選択 -->
			<p>
				<!-- スタッフ選択のラベル -->
				<label for="staffId">希望スタッフ:</label>
				<!-- スタッフ選択プルダウン（必須） -->
				<select id="staffId" name="staffId" required>
					<!-- 未選択用のダミー項目 -->
					<option value="">選択してください</option>
					<!-- staffs をループして option を生成 -->
					<option th:each="staff : ${staffs}" th:value="${staff.id}" th:text="${staff.name}"></option>
				</select>
				<!-- クライアントサイド検証のエラー表示領域 -->
				<span class="error-message" id="staffIdError"></span>
			</p>

			<!-- 入力ブロック：日付 -->
			<p>
				<!-- 日付のラベル -->
				<label for="waitDate">希望日:</label>
				<!-- type=date -->
				<input type="date" id="waitDate" name="waitDate" required>
				<!-- クライアントサイド検証のエラー表示領域 -->
				<span class="error-message" id="waitDateError"></span>
			</p>

			<!-- 入力ブロック：時間 -->
			<p>
				<!-- 時間のラベル -->
				<label for="startTime">希望時間:</label>
				<!-- 時間の選択肢（動的に読み込み） -->
				<select id="startTime" name="startTime" required>
					<option value="">日付とスタッフを選択してください</option>
				</select>
				<!-- クライアントサイド検証のエラー表示領域 -->
				<span class="error-message" id="startTimeError"></span>
			</p>

			<!-- 入力ブロック：メニュー -->
			<p>
				<!-- メニューのラベル -->
				<label for="reservationMenu">希望メニュー:</label>
				<!-- 自由入力のテキスト（必須） -->
				<input type="text" id="reservationMenu" name="reservationMenu" required>
				<!-- クライアントサイド検証のエラー表示領域 -->
				<span class="error-message" id="reservationMenuError"></span>
			</p>

			<!-- 注意事項 -->
			<div
				style="background-color: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffc107;">
				<h3 style="margin-top: 0; color: #856404;">キャンセル待ちについて</h3>
				<ul style="margin: 0; padding-left: 20px; color: #856404;">
					<li>キャンセル待ちは、希望の日時が満席の場合にご利用いただけます</li>
					<li>空きが出た場合、登録順に通知されます</li>
					<li>通知後、1時間以内に予約を確定してください</li>
					<li>期限内に確定されない場合、次の方に順番が回ります</li>
				</ul>
			</div>

			<!-- フォーム下部の操作ボタン群 -->
			<div class="button-group">
				<!-- 送信ボタン -->
				<button type="submit">キャンセル待ちを登録</button>
				<!-- キャンセル（ダッシュボードへ遷移） -->
				<a th:href="@{/dashboard}" class="button secondary">キャンセル</a>
			</div>
		</form>

		<!-- 自分のキャンセル待ち一覧 -->
		<h2>登録中のキャンセル待ち</h2>
		<table>
			<thead>
				<tr>
					<th>スタッフ</th>
					<th>希望日</th>
					<th>希望時間</th>
					<th>メニュー</th>
					<th>ステータス</th>
					<th>登録日時</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<!-- userWaitlists をループ表示 -->
				<tr th:each="waitlist : ${userWaitlists}">
					<!-- スタッフ名 -->
					<td th:text="${waitlist.staff.name}"></td>
					<!-- 希望日 -->
					<td th:text="${#temporals.format(waitlist.waitDate, 'yyyy-MM-dd')}"></td>
					<!-- 希望時間 -->
					<td th:text="${#temporals.format(waitlist.startTime, 'HH:mm')}"></td>
					<!-- メニュー -->
					<td th:text="${waitlist.reservationMenu}"></td>
					<!-- ステータス（PENDING/NOTIFIED/EXPIRED） -->
					<td>
						<span th:if="${waitlist.requestStatus == 'PENDING'}" style="color: #007bff;">待機中</span>
						<span th:if="${waitlist.requestStatus == 'NOTIFIED'}" style="color: #28a745;">通知済</span>
						<span th:if="${waitlist.requestStatus == 'EXPIRED'}" style="color: #6c757d;">期限切れ</span>
					</td>
					<!-- 登録日時 -->
					<td th:text="${#temporals.format(waitlist.requestedAt, 'yyyy-MM-dd HH:mm')}"></td>
					<!-- 操作 -->
					<td>
						<!-- キャンセルフォーム（PENDING状態のみ表示） -->
						<form th:if="${waitlist.requestStatus == 'PENDING'}"
							th:action="@{/waitlist/{id}/cancel(id=${waitlist.id})}" method="post"
							style="display:inline;">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							<button type="submit" class="button danger" onclick="return confirm('キャンセル待ちを取り消しますか？');">
								取り消し
							</button>
						</form>
						<!-- NOTIFIED状態の場合は予約確定ボタン -->
						<a th:if="${waitlist.requestStatus == 'NOTIFIED'}"
							th:href="@{/waitlist/{id}/confirm(id=${waitlist.id})}" class="button">
							予約確定
						</a>
					</td>
				</tr>
				<!-- データなし時の代替行 -->
				<tr th:if="${#lists.isEmpty(userWaitlists)}">
					<td colspan="7">キャンセル待ちはありません。</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- 画面内スクリプト（動的な時間枠読み込み + バリデーション） -->
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const staffIdSelect = document.getElementById('staffId');
			const waitDateInput = document.getElementById('waitDate');
			const startTimeSelect = document.getElementById('startTime');
			const form = document.getElementById('waitlistForm');

			/**
			 * 時間枠の更新処理
			 */
			async function updateTimeSlots() {
				const staffId = staffIdSelect.value;
				const date = waitDateInput.value;

				// スタッフか日付が未選択なら処理しない
				if (!staffId || !date) {
					startTimeSelect.innerHTML = '<option value="">日付とスタッフを選択してください</option>';
					return;
				}

				try {
					const response = await fetch(`/reservation/available-slots?staffId=${staffId}&date=${date}`);

					if (!response.ok) {
						throw new Error('サーバーエラーが発生しました');
					}

					const data = await response.json();
					startTimeSelect.innerHTML = '<option value="">時間を選択してください</option>';

					if (data && data.length > 0) {
						data.forEach(slot => {
							const option = document.createElement('option');

							let displayTime = "";
							let valueTime = "";

							// JavaのLocalTimeが[時, 分]の配列で届く場合
							if (Array.isArray(slot)) {
								const hh = String(slot[0]).padStart(2, '0');
								const mm = String(slot[1]).padStart(2, '0');
								displayTime = `${hh}:${mm}`;
								valueTime = `${hh}:${mm}:00`; // 秒まで含めてvalueにする
							}
							// 万が一文字列で届く場合
							else if (typeof slot === 'string') {
								displayTime = slot.substring(0, 5);
								valueTime = slot;
							}

							option.value = valueTime;
							option.textContent = displayTime;
							startTimeSelect.appendChild(option);
						});
					} else {
						const option = document.createElement('option');
						option.textContent = "予約可能な時間がありません";
						option.disabled = true;
						startTimeSelect.appendChild(option);
					}
				} catch (error) {
					console.error('Fetch error:', error);
					// 画面上のエラーメッセージ要素に表示（なければalert）
					const errorDiv = document.querySelector('.error-message');
					if (errorDiv) {
						errorDiv.textContent = '時間枠の取得に失敗しました。ページを再読み込みしてください。';
					} else {
						alert('エラーが発生しました。コンソールで原因を確認してください。');
					}
				}
			}

			// イベントリスナーの設定
			staffIdSelect.addEventListener('change', updateTimeSlots);
			waitDateInput.addEventListener('change', updateTimeSlots);

			// フォーム送信前のクライアントサイド検証関数
			window.validateForm = function () {
				let isValid = true;
				// 既存のエラーメッセージをクリア
				document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

				// 入力値の現在値を取得
				const staffId = staffIdSelect.value;
				const waitDate = waitDateInput.value;
				const startTime = startTimeSelect.value;
				const reservationMenu = document.getElementById('reservationMenu').value;

				// スタッフ未選択のチェック
				if (!staffId) {
					document.getElementById('staffIdError').textContent = 'スタッフを選択してください。';
					isValid = false;
				}

				// 日付未入力のチェック
				if (!waitDate) {
					document.getElementById('waitDateError').textContent = '日付を選択してください。';
					isValid = false;
				} else {
					// 過去日チェック
					const today = new Date();
					today.setHours(0, 0, 0, 0);
					const selectedDate = new Date(waitDate);
					if (selectedDate < today) {
						document.getElementById('waitDateError').textContent = '過去の日付は選択できません。';
						isValid = false;
					}
				}

				// 時間未選択のチェック
				if (!startTime) {
					document.getElementById('startTimeError').textContent = '時間を選択してください。';
					isValid = false;
				}

				// メニュー未入力のチェック
				if (!reservationMenu.trim()) {
					document.getElementById('reservationMenuError').textContent = 'メニューを入力してください。';
					isValid = false;
				}

				return isValid;
			};
		});
	</script>
</body>

</html>
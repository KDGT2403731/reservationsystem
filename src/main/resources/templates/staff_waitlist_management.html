<!-- HTML5 宣言 -->
<!DOCTYPE html>
<!-- ルート要素。日本語、Thymeleaf と Spring Security の名前空間を宣言 -->
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<!-- メタ情報・スタイル -->

<head>
	<!-- 文字コード -->
	<meta charset="UTF-8">
	<!-- ページタイトル -->
	<title>キャンセル待ち管理 - 予約管理システム</title>
	<!-- 共通スタイル -->
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<!-- 本文 -->

<body>
	<!-- レイアウトコンテナ -->
	<div class="container">
		<!-- 見出し -->
		<h1>キャンセル待ち管理</h1>
		<!-- ページ説明 -->
		<p>キャンセル待ちの顧客を管理します。</p>

		<!-- 成功メッセージ -->
		<div th:if="${param.success}" class="success-message">
			<span th:if="${param.success[0] == 'notified'}">顧客に通知しました。</span>
			<span th:if="${param.success[0] == 'cancelled'}">キャンセル待ちを取り消しました。</span>
			<span th:if="${param.success[0] == 'confirmed'}">予約が確定されました。</span>
		</div>

		<!-- エラーメッセージを追加 -->
		<div th:if="${param.error}" class="error-message" th:text="${param.error[0]}"></div>

		<!-- フィルタフォーム -->
		<h2>絞り込み</h2>
		<form th:action="@{/staff/waitlist}" method="get" class="filter-form">
			<!-- 日付フィルタ -->
			<div>
				<label for="filterDate">日付:</label>
				<input type="date" id="filterDate" name="date" th:value="${param.date}">
			</div>
			<!-- ステータスフィルタ -->
			<div>
				<label for="filterStatus">ステータス:</label>
				<select id="filterStatus" name="status">
					<option value="">すべて</option>
					<option value="PENDING" th:selected="${param.status == 'PENDING'}">待機中</option>
					<option value="NOTIFIED" th:selected="${param.status == 'NOTIFIED'}">通知済</option>
					<option value="EXPIRED" th:selected="${param.status == 'EXPIRED'}">期限切れ</option>
				</select>
			</div>
			<button type="submit" class="button">フィルタ</button>
		</form>

		<!-- 統計情報 -->
		<div style="background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px;">
			<h3 style="margin-top: 0;">現在の状況</h3>
			<div style="display: flex; gap: 30px;">
				<div>
					<strong>待機中:</strong>
					<span th:text="${waitlistStats.pending}" style="color: #007bff; font-size: 1.5em;">0</span>件
				</div>
				<div>
					<strong>通知済:</strong>
					<span th:text="${waitlistStats.notified}" style="color: #28a745; font-size: 1.5em;">0</span>件
				</div>
				<div>
					<strong>期限切れ:</strong>
					<span th:text="${waitlistStats.expired}" style="color: #6c757d; font-size: 1.5em;">0</span>件
				</div>
			</div>
		</div>

		<!-- キャンセル待ち一覧 -->
		<h2>キャンセル待ち一覧</h2>
		<table>
			<thead>
				<tr>
					<th>顧客名</th>
					<th>スタッフ</th>
					<th>希望日</th>
					<th>希望時間</th>
					<th>メニュー</th>
					<th>ステータス</th>
					<th>登録日時</th>
					<th>通知日時</th>
					<th>期限</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<!-- waitlists をループ表示 -->
				<tr th:each="waitlist : ${waitlists}">
					<!-- 顧客名 -->
					<td th:text="${waitlist.user.name}"></td>
					<!-- スタッフ名 -->
					<td th:text="${waitlist.staff.name}"></td>
					<!-- 希望日 -->
					<td th:text="${#temporals.format(waitlist.waitDate, 'yyyy-MM-dd')}"></td>
					<!-- 希望時間 -->
					<td th:text="${#temporals.format(waitlist.startTime, 'HH:mm')}"></td>
					<!-- メニュー -->
					<td th:text="${waitlist.reservationMenu}"></td>
					<!-- ステータス -->
					<td>
						<span th:if="${waitlist.requestStatus == 'PENDING'}" style="color: #ff00ff; font-weight: bold;">
							待機中
						</span>
						<span th:if="${waitlist.requestStatus == 'NOTIFIED'}"
							style="color: #ff8c00; font-weight: bold;">
							通知済
						</span>
						<span th:if="${waitlist.requestStatus == 'EXPIRED'}" style="color: #6c757d; font-weight: bold;">
							期限切れ
						</span>
					</td>
					<!-- 登録日時 -->
					<td th:text="${#temporals.format(waitlist.requestedAt, 'yyyy-MM-dd HH:mm')}"></td>
					<!-- 通知日時 -->
					<td
						th:text="${waitlist.notifiedAt != null ? #temporals.format(waitlist.notifiedAt, 'yyyy-MM-dd HH:mm') : '-'}">
					</td>
					<!-- 期限 -->
					<td>
						<span th:if="${waitlist.expirationTime != null}">
							<span th:text="${#temporals.format(waitlist.expirationTime, 'yyyy-MM-dd HH:mm')}"></span>
							<!-- 期限切れまでの時間を表示 -->
							<span th:if="${waitlist.requestStatus == 'NOTIFIED'}"
								th:classappend="${waitlist.isExpiringSoon ? 'text-danger' : ''}"
								style="display: block; font-size: 0.85em;">
								(<span th:text="${waitlist.timeRemaining}"></span>)
							</span>
						</span>
						<span th:if="${waitlist.expirationTime == null}">-</span>
					</td>
					<!-- 操作 -->
					<td>
						<!-- 待機中：手動通知ボタン -->
						<div th:if="${waitlist.requestStatus == 'PENDING'}">
							<form th:action="@{/staff/waitlist/{id}/notify(id=${waitlist.id})}" method="post"
								style="display:inline;">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
								<button type="submit" class="button" onclick="return confirm('顧客に通知を送信しますか？');">
									通知
								</button>
							</form>
						</div>

						<!-- 通知済：予約確定ボタン -->
						<div th:if="${waitlist.requestStatus == 'NOTIFIED'}">
							<a th:href="@{/staff/waitlist/{id}/confirm(id=${waitlist.id})}" class="button">
								予約確定
							</a>
						</div>

						<!-- 共通：取り消しボタン（期限切れ以外） -->
						<form th:if="${waitlist.requestStatus != 'EXPIRED'}"
							th:action="@{/staff/waitlist/{id}/cancel(id=${waitlist.id})}" method="post"
							style="display:inline; margin-top: 5px;">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							<button type="submit" class="button danger" onclick="return confirm('このキャンセル待ちを取り消しますか？');">
								取消
							</button>
						</form>
					</td>
				</tr>
				<!-- データなし時の代替行 -->
				<tr th:if="${#lists.isEmpty(waitlists)}">
					<td colspan="10">キャンセル待ちはありません。</td>
				</tr>
			</tbody>
		</table>

		<!-- 注意事項 -->
		<div
			style="background-color: #d1ecf1; padding: 15px; margin: 20px 0; border-radius: 5px; border: 1px solid #bee5eb;">
			<h3 style="margin-top: 0; color: #0c5460;">運用のポイント</h3>
			<ul style="margin: 0; padding-left: 20px; color: #0c5460;">
				<li><strong>自動通知:</strong> 予約がキャンセルされると、該当の日時・スタッフで待機中の顧客に自動で通知されます</li>
				<li><strong>手動通知:</strong> 急な空きが出た場合など、手動で顧客に通知することもできます</li>
				<li><strong>通知期限:</strong> 通知後1時間以内に顧客が予約を確定しない場合、自動的に期限切れとなります</li>
				<li><strong>順番:</strong> 同じ条件で複数のキャンセル待ちがある場合、登録が早い順に通知されます</li>
			</ul>
		</div>

		<!-- 下部ナビ -->
		<div class="button-group">
			<a th:href="@{/dashboard}" class="button secondary">ダッシュボードに戻る</a>
		</div>
	</div>
</body>

</html>
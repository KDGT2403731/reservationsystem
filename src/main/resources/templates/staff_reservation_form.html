<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>予約編集 - 予約管理システム</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
	<div class="container">
		<h1>予約編集（スタッフ用）</h1>
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

		<form id="reservationForm" th:action="@{/staff/reservations/{id}/edit(id=${reservation.id})}" method="post"
			onsubmit="return validateForm()">
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
			<!-- 入力ブロック：スタッフ選択 -->
			<p>
				<label for="staffId">スタッフ:</label>
				<select id="staffId" name="staffId" required>
					<option value="">スタッフを選択してください</option>
					<option th:each="staff : ${staffs}" th:value="${staff.id}" th:text="${staff.name}"
						th:selected="${reservation.staff != null and reservation.staff.id == staff.id}">
					</option>
				</select>
				<span class="error-message" id="staffIdError"></span>
			</p>

			<p>
				<label for="date">日付:</label>
				<input type="date" id="date" name="date" th:value="${reservation.date}" required>
				<span class="error-message" id="dateError"></span>
			</p>

			<p>
				<label for="timeSlot">時間:</label>
				<select id="timeSlot" name="timeSlot" required>
					<option value="" disabled>日付とスタッフを選択してください</option>
					<option th:if="${reservation.timeSlot != null}" th:value="${reservation.timeSlot}"
						th:text="${reservation.timeSlot}" selected>
					</option>
				</select>
				<span class="error-message" id="timeSlotError"></span>
			</p>

			<p>
				<label for="menu">メニュー:</label>
				<input type="text" id="menu" name="menu" th:value="${reservation.menu}" required>
				<span class="error-message" id="menuError"></span>
			</p>

			<div class="button-group">
				<button type="submit">更新する</button>
				<a th:href="@{/staff/reservations}" class="button secondary">キャンセル</a>
			</div>
		</form>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const staffIdSelect = document.getElementById('staffId');
			const dateInput = document.getElementById('date');
			const timeSlotSelect = document.getElementById('timeSlot');
			const form = document.getElementById('reservationForm');

			/**
			 * 時間枠の更新処理
			 */
			async function updateTimeSlots() {
				const staffId = staffIdSelect.value;
				const date = dateInput.value;

				// スタッフか日付が未選択なら処理しない
				if (!staffId || !date) {
					timeSlotSelect.innerHTML = '<option value="">時間を選択してください</option>';
					return;
				}

				try {
					const response = await fetch(`/reservation/available-slots?staffId=${staffId}&date=${date}`);

					if (!response.ok) {
						throw new Error('サーバーエラーが発生しました');
					}

					const data = await response.json();
					timeSlotSelect.innerHTML = '<option value="">時間を選択してください</option>';

					if (data && data.length > 0) {
						data.forEach(slot => {
							const option = document.createElement('option');

							let displayTime = "";
							let valueTime = "";

							// JavaのLocalTimeが[時, 分]の配列で届く場合
							if (Array.isArray(slot)) {
								const hh = String(slot[0]).padStart(2, '0');
								const mm = String(slot[1]).padStart(2, '0');
								displayTime = `${hh}:${mm}`;
								valueTime = `${hh}:${mm}:00`; // 秒まで含めてvalueにする
							}
							// 万が一文字列で届く場合
							else if (typeof slot === 'string') {
								displayTime = slot.substring(0, 5);
								valueTime = slot;
							}

							option.value = valueTime;
							option.textContent = displayTime;
							timeSlotSelect.appendChild(option);
						});
					} else {
						const option = document.createElement('option');
						option.textContent = "予約可能な時間がありません";
						option.disabled = true;
						timeSlotSelect.appendChild(option);
					}
				} catch (error) {
					console.error('Fetch error:', error);
					// 画面上のエラーメッセージ要素に表示（なければalert）
					const errorDiv = document.querySelector('.error-message');
					if (errorDiv) {
						errorDiv.textContent = '時間枠の取得に失敗しました。ページを再読み込みしてください。';
					} else {
						alert('エラーが発生しました。の原因をコンソールで確認してください。');
					}
				}
			}

			/**
			 * バリデーション処理
			 */
			window.validateForm = function () {
				let isValid = true;
				// メッセージをクリア
				document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

				const staffId = staffIdSelect.value;
				const date = dateInput.value;
				const timeSlot = timeSlotSelect.value;
				const menu = document.getElementById('menu').value;

				if (!staffId) {
					document.getElementById('staffIdError').textContent = 'スタッフを選択してください。';
					isValid = false;
				}
				if (!date) {
					document.getElementById('dateError').textContent = '日付を選択してください。';
					isValid = false;
				}
				if (!timeSlot) {
					document.getElementById('timeSlotError').textContent = '時間を選択してください。';
					isValid = false;
				}
				if (!menu.trim()) {
					document.getElementById('menuError').textContent = 'メニューを入力してください。';
					isValid = false;
				}

				return isValid;
			};

			// イベントリスナーの設定
			staffIdSelect.addEventListener('change', updateTimeSlots);
			dateInput.addEventListener('change', updateTimeSlots);

			// 初期表示時に値があれば読み込み
			if (staffIdSelect.value && dateInput.value) {
				updateTimeSlots();
			}
		});
	</script>

</body>

</html>
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>予約編集 - 予約管理システム</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
	<div class="container">
		<h1>予約編集（スタッフ用）</h1>
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

		<form id="reservationForm" th:action="@{/staff/reservations/{id}/edit(id=${reservation.id})}" method="post"
			onsubmit="return validateForm()">
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
			<!-- 入力ブロック：スタッフ選択 -->
			<p>
				<label for="staffId">スタッフ:</label>
				<select id="staffId" name="staffId" required>
					<option value="">スタッフを選択してください</option>
					<option th:each="staff : ${staffs}" th:value="${staff.id}" th:text="${staff.name}"
						th:selected="${reservation.staff != null and reservation.staff.id == staff.id}">
					</option>
				</select>
				<span class="error-message" id="staffIdError"></span>
			</p>

			<p>
				<label for="date">日付:</label>
				<input type="date" id="date" name="date" th:value="${reservation.date}" required>
				<span class="error-message" id="dateError"></span>
			</p>

			<p>
				<label for="timeSlot">時間:</label>
				<select id="timeSlot" name="timeSlot" required>
					<option value="" disabled>日付とスタッフを選択してください</option>
					<option th:if="${reservation.timeSlot != null}" th:value="${reservation.timeSlot}"
						th:text="${reservation.timeSlot}" selected>
					</option>
				</select>
				<span class="error-message" id="timeSlotError"></span>
			</p>

			<p>
				<label for="menu">メニュー:</label>
				<input type="text" id="menu" name="menu" th:value="${reservation.menu}" required>
				<span class="error-message" id="menuError"></span>
			</p>

			<div class="button-group">
				<button type="submit">更新する</button>
				<a th:href="@{/staff/reservations}" class="button secondary">キャンセル</a>
			</div>
		</form>
	</div>

	<script>
		// =====================================
		// スタッフ用予約編集フォームの制御
		// =====================================
		document.addEventListener('DOMContentLoaded', function () {
			// DOM要素の取得
			const staffIdSelect = document.getElementById('staffId');
			const dateInput = document.getElementById('date');
			const timeSlotSelect = document.getElementById('timeSlot');
			const form = document.getElementById('reservationForm');

			/**
			 * 利用可能な時間枠を取得してドロップダウンを更新する
			 */
			async function updateTimeSlots() {
				const staffId = staffIdSelect.value;
				const date = dateInput.value;
				const timeSlotError = document.getElementById('timeSlotError');

				// エラーメッセージをクリア
				timeSlotError.textContent = '';

				// 時間枠のドロップダウンをリセット
				timeSlotSelect.innerHTML = '';
				const defaultOption = document.createElement('option');
				defaultOption.value = '';
				defaultOption.disabled = true;
				defaultOption.selected = true;
				defaultOption.textContent = '希望の時間を選択してください';
				timeSlotSelect.appendChild(defaultOption);

				// スタッフと日付が両方選択されていない場合は処理終了
				if (!staffId || !date) {
					return;
				}

				try {
					// APIから利用可能な時間枠を取得
					const params = new URLSearchParams({
						staffId: staffId,
						date: date
					});

					const response = await fetch(`/reservation/available-slots?${params}`);

					// レスポンスチェック
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const data = await response.json();

					// データが存在し、配列の場合のみ処理
					if (Array.isArray(data) && data.length > 0) {
						// 既存の予約時間を保存
						const currentReservationTime = timeSlotSelect.querySelector('option[value!=""]')?.value;

						// APIから取得した時間枠をオプションに追加
						data.forEach(slot => {
							const option = document.createElement('option');
							// LocalTime形式 "09:00:00" から "09:00" に変換
							const displayTime = slot.substring(0, 5);
							option.value = slot;
							option.textContent = displayTime;
							timeSlotSelect.appendChild(option);
						});

						// 既存の予約時間があれば選択
						if (currentReservationTime && data.includes(currentReservationTime)) {
							timeSlotSelect.value = currentReservationTime;
						}
					} else {
						// 利用可能な時間枠がない場合
						const noOption = document.createElement('option');
						noOption.value = '';
						noOption.textContent = '利用可能な時間枠がありません';
						timeSlotSelect.appendChild(noOption);
					}
				} catch (error) {
					// エラーハンドリング
					console.error('時間枠取得エラー:', error);
					const errorOption = document.createElement('option');
					errorOption.value = '';
					errorOption.textContent = '時間枠の取得に失敗しました';
					timeSlotSelect.appendChild(errorOption);
					timeSlotError.textContent = 'エラーが発生しました。ページを再度読み込んでください。';
				}
			}

			/**
			 * フォーム送信時のバリデーション
			 */
			function validateForm() {
				let isValid = true;

				// エラーメッセージを全クリア
				document.querySelectorAll('.error-message').forEach(el => {
					el.textContent = '';
				});

				// 入力値の取得
				const staffId = staffIdSelect.value;
				const date = dateInput.value;
				const timeSlot = timeSlotSelect.value;
				const menu = document.getElementById('menu').value;

				// 個別の検証
				if (!staffId) {
					document.getElementById('staffIdError').textContent = 'スタッフを選択してください。';
					isValid = false;
				}

				if (!date) {
					document.getElementById('dateError').textContent = '日付を選択してください。';
					isValid = false;
				}

				if (!timeSlot) {
					document.getElementById('timeSlotError').textContent = '時間を選択してください。';
					isValid = false;
				}

				if (!menu.trim()) {
					document.getElementById('menuError').textContent = 'メニューを入力してください。';
					isValid = false;
				}

				return isValid;
			}

			// ページロード時に既に値が入力されている場合は時間枠を取得
			if (staffIdSelect.value && dateInput.value) {
				updateTimeSlots();
			}

			// スタッフまたは日付が変更されたら時間枠を更新
			staffIdSelect.addEventListener('change', updateTimeSlots);
			dateInput.addEventListener('change', updateTimeSlots);

			// フォーム送信時のバリデーション
			form.addEventListener('submit', function (e) {
				if (!validateForm()) {
					e.preventDefault();
					return false;
				}
			});

			// グローバルに validateForm を公開（HTML属性の onsubmit から呼び出し可能にする）
			window.validateForm = validateForm;
		});
	</script>

</body>

</html>